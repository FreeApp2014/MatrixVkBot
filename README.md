# Бот для получения и отправки сообщений через мессенджер ВКонтакте из децентрализованной сети Matrix

Бот не требует наличия собственного Matrix-сервера, он работает с правами обычного пользователя, поэтому им можно пользоваться на любом Matrix-сервере.

_На данный момент ВКонтакте блокирует доступ к API сообщений пользователя для большинства вновь созданных приложений. Как обходное решение предлагается использовать идентификатор любого другого старого приложения, которому выдали доступ к сообщениям пользователей, например идентификатор приложения [Kate Mobile](https://vk.com/kate_mobile) - app id `2685278`. В дальнейшем, когда ВКонтакте устранит проблемы с доступом для новых приложений, можно будет использовать своё приложение._

## Принцип работы:

1. Пользователь начинает диалог в Матрице с ботом (создаёт прямой чат с ботом), и производит автризацию приложения в ВК для доступа к сообщениям.
2. При поступлении пользователю новых сообщений в ВК - бот создаёт новую комнату, приглашает туда пользователя и переименовывает эту комнату по названию диалога в ВК, и дублирует туда все сообщения из чата ВКонтакте.
4. Пользователь может попросить бота вывести список всех диалогов в ВК и открыть нужный диалог в Матрице, используя команды в комнате управления ботом.
5. Если диалог - групповой чат, то бот к каждой реплике в комнате группового чата добавляет префиксом ФИО отправителя.

## Настройка:

1. Заводим учётную запись для бота в Матрице, как для обычного пользователя на каком-либо сервере матрицы (вида @botvk:matrix.org)
2. Скачиваем себе бота: `git clone https://github.com/progserega/MatrixVkBot.git`
3. Ставим зависимости: `apt-get install python3-dev python3-pip; pip3 install matrix_client Pillow ujson setuptools vk`
4. Копируем файл конфигурации из примера: `cp config.py.example config.py` 
5. Указываем в файле конфигурации `config.py` логин-пароль от учётной записи бота, созданной в пункте 1.
6. Запускаем бота: `./bot.py`
7. Создаём новый чат с ботом, он должен принять приглашение автоматически.
8. Пишем в чате ему команду: `!login` и следуем дальнейшим инструкциям бота.

### Для авторизации бот попросит (после ввода команды `!login`) провести следующий диалог:
1. попросит создать VKapp в ВК (даст ссылку)
2. Зайти в настройки VKapp и скопировать его id
3. отправить этот ID боту
4. бот в ответ отправит ссылку по которой пользователь должен зайти в браузере и согласиться на доступ.
5. После соглашения произойдёт редирект на страничку с предупреждающим текстом
6. Скопировать адрес этой странички и отправить её боту
7. После этого, если всё пройдёт удачно - бот сообщит, что вы вошли под "Ваше ФИО"

## Использование команд бота:
1. Новые сообщения в диалогах из ВК будут приниматься ботом и отправляться во вновь созданные комнтаты в матрице с именем диалога в ВК
2. Для того, чтобы отправить сообщение в диалог в ВК, нужно передать боту команду: `!dialogs` - бот выведет список диалогов и их порядковые номера.
3. Необходимо в ответном сообщении боту отправить номер нужного диалога, бот создаст новую комнату (если её нет для этого диалога) и пригласит туда пользователя.
4. Если пользователь покинет комнату, созданную ботом, то бот отметит это у себя и в случае, если в этот диалог (ВК-шный) придёт новое сообщение из ВК, то бот заново создаст комнату и пригласит заново туда пользователя.

## Недоработки:
1. Пока не реализована команда !logout

## Реализовано:

ВК->MATRIX:
1. видео 
2. картинки
3. перенаправленные сообщения
4. местоположение
5. музыка
6. голосовые сообщения
7. текстовые сообщения
8. пересылаемые записи на стене

MATRIX->VK:
1. текстовые сообщения
2. изображения
3. обычные файлы
4. видео
5. Базовая поддержка оформления сообщений, как ответов на предыдущие сообщения.
